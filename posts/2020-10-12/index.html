<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Model Predictive Control for a Legged Robot | Ben Bokser's Blog</title>
<meta name=keywords content="control,spryped"><meta name=description content="I have recently implemented a model predictive controller (MPC) to calculate the necessary reaction forces for a legged robot. The work presented here is based on this paper by Kim et al. If you don&rsquo;t know what model predictive control is, I recommend this excellent explanation by Steve Brunton. I also found this guide to model predictive control with CasADI to be extremely helpful. CasADi is an open source nonlinear optimization tool which I&rsquo;m using for MPC."><meta name=author content="Ben Bokser"><link rel=canonical href=https://bbokser.github.io/posts/2020-10-12/><link crossorigin=anonymous href=/assets/css/stylesheet.f5e4015d42de28790ef5dd03b8bc8041968f8b08d6b8a41faded98c8e9953483.css integrity="sha256-9eQBXULeKHkO9d0DuLyAQZaPiwjWuKQfre2YyOmVNIM=" rel="preload stylesheet" as=style><link rel=icon href=https://bbokser.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://bbokser.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://bbokser.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://bbokser.github.io/apple-touch-icon.png><link rel=mask-icon href=https://bbokser.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://bbokser.github.io/posts/2020-10-12/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js onload=renderMathInElement(document.body)></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><meta property="og:url" content="https://bbokser.github.io/posts/2020-10-12/"><meta property="og:site_name" content="Ben Bokser's Blog"><meta property="og:title" content="Model Predictive Control for a Legged Robot"><meta property="og:description" content="I have recently implemented a model predictive controller (MPC) to calculate the necessary reaction forces for a legged robot. The work presented here is based on this paper by Kim et al. If you don’t know what model predictive control is, I recommend this excellent explanation by Steve Brunton. I also found this guide to model predictive control with CasADI to be extremely helpful. CasADi is an open source nonlinear optimization tool which I’m using for MPC."><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-10-12T00:00:00+00:00"><meta property="article:modified_time" content="2020-10-12T00:00:00+00:00"><meta property="article:tag" content="Control"><meta property="article:tag" content="Spryped"><meta name=twitter:card content="summary"><meta name=twitter:title content="Model Predictive Control for a Legged Robot"><meta name=twitter:description content="I have recently implemented a model predictive controller (MPC) to calculate the necessary reaction forces for a legged robot. The work presented here is based on this paper by Kim et al. If you don&rsquo;t know what model predictive control is, I recommend this excellent explanation by Steve Brunton. I also found this guide to model predictive control with CasADI to be extremely helpful. CasADi is an open source nonlinear optimization tool which I&rsquo;m using for MPC."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://bbokser.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Model Predictive Control for a Legged Robot","item":"https://bbokser.github.io/posts/2020-10-12/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Model Predictive Control for a Legged Robot","name":"Model Predictive Control for a Legged Robot","description":"I have recently implemented a model predictive controller (MPC) to calculate the necessary reaction forces for a legged robot. The work presented here is based on this paper by Kim et al. If you don\u0026rsquo;t know what model predictive control is, I recommend this excellent explanation by Steve Brunton. I also found this guide to model predictive control with CasADI to be extremely helpful. CasADi is an open source nonlinear optimization tool which I\u0026rsquo;m using for MPC.\n","keywords":["control","spryped"],"articleBody":"I have recently implemented a model predictive controller (MPC) to calculate the necessary reaction forces for a legged robot. The work presented here is based on this paper by Kim et al. If you don’t know what model predictive control is, I recommend this excellent explanation by Steve Brunton. I also found this guide to model predictive control with CasADI to be extremely helpful. CasADi is an open source nonlinear optimization tool which I’m using for MPC.\nHowever, I’m not entirely sure yet whether this code works the way it’s intended–I’m not getting any error messages, but the force values I’m getting seem too low. If you spot anything wrong with my implementation, please let me know.\n​Here’s the code.\nPart 1. The Dynamics Formulation From the paper, we have the following discrete dynamics:\n$$ x(k+1) = A_kx(k) + B_k \\hat{f_k} + \\hat{g} $$\nwhere,\n$$ \\begin{equation} x = \\begin{bmatrix} \\theta^{\\top} \u0026 p^{\\top} \u0026 \\omega^{\\top} \u0026 \\dot{p}^{\\top} \\end{bmatrix}^{\\top} \\end{equation} $$\n$$ \\begin{equation} \\hat{f} = \\begin{bmatrix} f_1 \u0026 … \u0026 f_n \\end{bmatrix}^{\\top} \\end{equation} $$\n$$ \\begin{equation} \\hat{g} = \\begin{bmatrix} 0_{1\\times{}3} \u0026 0_{1\\times{}3} \u0026 0_{1\\times{}3} \u0026 g^{\\top} \\end{bmatrix}^{\\top} \\end{equation} $$\n$$ \\begin{equation} A = \\begin{bmatrix} 1_{3\\times3} \u0026 0_{3\\times3} \u0026 R_z(\\psi)\\Delta t \u0026 0_{3\\times3} \\newline 0_{3\\times3} \u0026 1_{3\\times3} \u0026 0_{3\\times3} \u0026 1_{3\\times3} \\Delta t \\newline 0_{3\\times3} \u0026 0_{3\\times3} \u0026 1_{3\\times3} \u0026 0_{3\\times3} \\newline 0_{3\\times3} \u0026 0_{3\\times3} \u0026 0_{3\\times3} \u0026 1_{3\\times3} \\end{bmatrix} \\end{equation} $$\n$$ \\begin{equation} B = \\begin{bmatrix} 0_{3\\times3} \u0026 0_{3\\times3} \\newline 0_{3\\times3} \u0026 0_{3\\times3} \\newline {}_GI^{-1}[r_1]_\\times \\Delta t \u0026 {}_GI^{-1}[r_1]_\\times \\Delta t \\newline 1_{3\\times3} \\Delta t /m \u0026 1_{3\\times3} \\Delta t /m \\end{bmatrix} \\end{equation} $$ First off, you may be wondering what this notation means.\n$[r_1]_\\times$ refers to a skew-symmetric matrix. The $3\\times1$ vectors $r_1$ and $r_2$ (footstep positions) are converted into a $3\\times3$ matrix in order to perform a cross product operation with the inverse of the global inertia tensor.\n% matlab code r = [[0, -r_z, r_y]; [r_z, 0, -r_x]; [-r_y, r_x, 0]]; i_inv = sym('i', [3, 3]); mtimes(i_inv, r) A few more notes:\nThe state term $x$ is a $12\\times1$ vector composed of the angle, position, angular velocity, and velocity of the body w.r.t. to the global frame. In my case, there are only two legs, so there six scalar control values: $f_{1x}$, $f_{1y}$, $f_{1z}$, $f_{2x}$, $f_{2y}$, $f_{2z}$. The gravity term $\\hat{g}$ is a $12\\times1$ vector of zeros until the last term, which is the gravitational constant. $R_z$ is a $3\\times3$ rotation matrix for translating angular velocity from the global frame to the body frame. % matlab code syms theta_x theta_y theta_z p_x p_y p_z omega_x omega_y omega_z pdot_x ... pdot_y pdot_z f1_x f1_y f1_z f2_x f2_y f2_z ... dt i_inv r1x r1y r1z r2x r2y r2z mass gravity... i11 i12 i13 i21 i22 i23 i31 i32 i33... rz11 rz12 rz13 rz21 rz22 rz23 rz31 rz32 rz33 x = [[theta_x]; % states [theta_y]; [theta_z]; [p_x]; [p_y]; [p_z]; [omega_x]; [omega_y]; [omega_z]; [pdot_x]; [pdot_y]; [pdot_z]]; f = [[f1_x]; % controls [f1_y]; [f1_z]; [f2_x]; [f2_y]; [f2_z]]; g = [[0]; [0]; [0]; [0]; [0]; [0]; [0]; [0]; [0]; [0]; [0]; [gravity]]; A = [[1, 0, 0, 0, 0, 0, rz11*dt, rz12*dt, rz13*dt, 0, 0, 0]; [0, 1, 0, 0, 0, 0, rz21*dt, rz22*dt, rz23*dt, 0, 0, 0]; [0, 0, 1, 0, 0, 0, rz31*dt, rz32*dt, rz33*dt, 0, 0, 0]; [0, 0, 0, 1, 0, 0, 0, 0, 0, dt, 0, 0]; [0, 0, 0, 0, 1, 0, 0, 0, 0, 0, dt, 0]; [0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, dt]; [0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0]; [0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0]; [0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0]; [0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0]; [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0]; [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1]]; B = [[0, 0, 0, 0, 0, 0]; [0, 0, 0, 0, 0, 0]; [0, 0, 0, 0, 0, 0]; [0, 0, 0, 0, 0, 0]; [0, 0, 0, 0, 0, 0]; [0, 0, 0, 0, 0, 0]; [(i12*r1z - i13*r1y)*dt, (-i11*r1z + i13*r1x)*dt, (i11*r1y - i12*r1x)*dt, ... (i12*r2z - i13*r2y)*dt, (-i11*r2z + i13*r2x)*dt, (i11*r2y - i12*r2x)*dt]; [(i22*r1z - i23*r1y)*dt, (-i21*r1z + i23*r1x)*dt, (i21*r1y - i22*r1x)*dt, ... (i22*r2z - i23*r2y)*dt, (-i21*r2z + i23*r2x)*dt, (i21*r2y - i22*r2x)*dt]; [(i32*r1z - i33*r1y)*dt, (-i31*r1z + i33*r1x)*dt, (i31*r1y - i32*r1x)*dt, ... (i32*r2z - i33*r2y)*dt, (-i31*r2z + i33*r2x)*dt, (i31*r2y - i32*r2x)*dt]; [dt/mass, 0, 0, dt/mass, 0, 0]; [0, dt/mass, 0, 0, dt/mass, 0]; [0, 0, dt/mass, 0, 0, dt/mass]]; x_next = mtimes(A, x) + mtimes(B, f) + g; The end result is a very long equation which will be used as a constraint for the QP. The states and controls are defined as symbolics, but other values such as the inertia tensor, rotation matrix, and foot positions are fed in as numerical values from sensor feedback.\n# python gravity = -9.807 dt = self.dt mass = self.mass x_next = [dt * omega_x * rz11 + dt * omega_y * rz12 + dt * omega_z * rz13 + theta_x, dt * omega_x * rz21 + dt * omega_y * rz22 + dt * omega_z * rz23 + theta_y, dt * omega_x * rz31 + dt * omega_y * rz32 + dt * omega_z * rz33 + theta_z, dt * pdot_x + p_x, dt * pdot_y + p_y, dt * pdot_z + p_z, dt * f1_x * (i12 * r1z - i13 * r1y) + dt * f1_y * (-i11 * r1z + i13 * r1x) + dt * f1_z * (i11 * r1y - i12 * r1x) + dt * f2_x * (i12 * r2z - i13 * r2y) + dt * f2_y * (-i11 * r2z + i13 * r2x) + dt * f2_z * (i11 * r2y - i12 * r2x) + omega_x, dt * f1_x * (i22 * r1z - i23 * r1y) + dt * f1_y * (-i21 * r1z + i23 * r1x) + dt * f1_z * (i21 * r1y - i22 * r1x) + dt * f2_x * (i22 * r2z - i23 * r2y) + dt * f2_y * (-i21 * r2z + i23 * r2x) + dt * f2_z * (i21 * r2y - i22 * r2x) + omega_y, dt * f1_x * (i32 * r1z - i33 * r1y) + dt * f1_y * (-i31 * r1z + i33 * r1x) + dt * f1_z * (i31 * r1y - i32 * r1x) + dt * f2_x * (i32 * r2z - i33 * r2y) + dt * f2_y * (-i31 * r2z + i33 * r2x) + dt * f2_z * (i31 * r2y - i32 * r2x) + omega_z, dt * f1_x / mass + dt * f2_x / mass + pdot_x, dt * f1_y / mass + dt * f2_y / mass + pdot_y, dt * f1_z / mass + dt * f2_z / mass + gravity + pdot_z] self.fn = cs.Function('fn', [theta_x, theta_y, theta_z, p_x, p_y, p_z, omega_x, omega_y, omega_z, pdot_x, pdot_y, pdot_z, f1_x, f1_y, f1_z, f2_x, f2_y, f2_z], x_next) # nonlinear mapping of function f(x,u) Part 2. The Objective Function $$ \\begin{align} \\min_{x,f} \\quad \u0026 \\sum^{m}_{k=0} \\lVert x(k+1) - x^{ref}(k+1) \\lVert_Q + \\lVert f_k\\lVert_R \\end{align} $$\nThe objective function is shown above.\n$$ \\lVert f(k)\\lVert_R $$\nLet’s start with this notation. What does it mean? Well, double bars represent a matrix norm. However, the R in subscript clues us into the fact that this is a special case of the matrix norm with an inner product. Q and R are weighing matrices and should be diagonal.\n$$ \\begin{equation} \\lVert f(k)\\lVert_R = \\sqrt{f(k)_R} = \\sqrt{f(k)*R*f(k)} \\end{equation} $$ However, I’m not sure what the purpose of the square root would be here. It seems to me that minimizing the square root of $f(x)$ is basically equivalent to minimizing $f(x)$ by itself, but more computationally expensive. In fact, running the code with the square root operation actually causes a QP is infeasible! error. As such, I’m leaving the square root operation out.\nSo, the objective function minimizes $x$ and $f$ (the state and control vectors) based on the difference between actual and reference state as well as the value of $f$, scaled to Q and R respectively, over $k$ time steps where $k$ is between 0 and $m$. Here, $m$ refers to the prediction horizon, which is chosen by the user.\nu = cs.SX.sym('u', self.n_controls, self.N) # decision variables, control action matrix st_ref = cs.SX.sym('st_ref', self.n_states + self.n_states) # initial and reference states x = cs.SX.sym('x', self.n_states, (self.N + 1)) # represents the states over the opt problem. obj = 0 # cs.SX(0) # objective function constr = [] # constraints vector Q = np.zeros((12, 12)) # state weighing matrix Q[0, 0] = 1 Q[1, 1] = 1 Q[2, 2] = 1 Q[3, 3] = 1 Q[4, 4] = 1 Q[5, 5] = 1 Q[6, 6] = 1 Q[7, 7] = 1 Q[8, 8] = 1 Q[9, 9] = 1 Q[10, 10] = 1 Q[11, 11] = 1 R = np.zeros((6, 6)) # control weighing matrix R[0, 0] = 1 R[1, 1] = 1 R[2, 2] = 1 R[3, 3] = 1 R[4, 4] = 1 R[5, 5] = 1 st = x[:, 0] # initial state constr = cs.vertcat(constr, st - st_ref[0:self.n_states]) # initial condition constraints # compute objective and constraints for k in range(0, self.N): st = x[:, k] # state con = u[:, k] # control action # calculate objective obj = obj + cs.mtimes(cs.mtimes((st - st_ref[self.n_states:(self.n_states * 2)]).T, Q), st - st_ref[self.n_states:(self.n_states * 2)])) \\ + cs.mtimes(cs.mtimes(con.T, R), con)) Both my Q and R are identity matrices right now, as I have not yet tuned them.\nPart 3. The Constraints Vector In the same for loop, we can now add the constraints vector. For each iteration of the loop, the discrete dynamics equation from Part 1 is subtracted from the next state vector, $x(k+1)$.\nfor k in range(0, self.N): # ... st_next = x[:, k + 1] f_value = self.fn(st[0], st[1], st[2], st[3], st[4], st[5], st[6], st[7], st[8], st[9], st[10], st[11], con[0], con[1], con[2], con[3], con[4], con[5]) st_n_e = np.array(f_value) constr = cs.vertcat(constr, st_next - st_n_e) # compute constraints There are more constraints, however. Namely, friction cone constraints, governed by friction of the feet with the ground. As stated in the paper:\n$$ \\begin{equation} \\vert{}f_x\\vert{} \\leq \\mu f_z \\end{equation} $$\n$$ \\begin{equation} \\vert{}f_x\\vert{} \\leq \\mu f_z \\end{equation} $$\n$$ \\begin{equation} f_z \u003e 0 \\end{equation} $$\nHere’s my implementation below. Both the $F_x$ and $F_y$ inequalities must be repeated due to the absolute value function. $F_z$ is not required here because it’s extremely simple and can be implemented as an input constraint.\n# add additional constraints for k in range(0, self.N): constr = cs.vertcat(constr, u[0, k] - self.mu * u[2, k]) # f1x - mu*f1z constr = cs.vertcat(constr, -u[0, k] - self.mu * u[2, k]) # -f1x - mu*f1z constr = cs.vertcat(constr, u[1, k] - self.mu * u[2, k]) # f1y - mu*f1z constr = cs.vertcat(constr, -u[1, k] - self.mu * u[2, k]) # -f1y - mu*f1z constr = cs.vertcat(constr, u[3, k] - self.mu * u[5, k]) # f2x - mu*f2z constr = cs.vertcat(constr, -u[3, k] - self.mu * u[5, k]) # -f2x - mu*f2z constr = cs.vertcat(constr, u[4, k] - self.mu * u[5, k]) # f2y - mu*f2z constr = cs.vertcat(constr, -u[4, k] - self.mu * u[5, k]) # -f2y - mu*f2z Part 4. Problem Setup The solver used here is qpOASES. The optimization variables (in this case, the state and controls), objective function, constraint functions, and reference state are declared as shown. It is important to specify a bound tolerance and termination tolerance.\nopt_variables = cs.vertcat(cs.reshape(x, n_states * (self.N + 1), 1), cs.reshape(u, n_controls * self.N, 1)) qp = {'x': opt_variables, 'f': obj, 'g': constr, 'p': st_ref} opts = {'print_time': 0, 'error_on_fail': 0, 'printLevel': \"low\", 'boundTolerance': 1e-6, 'terminationTolerance': 1e-6} solver = cs.qpsol('S', 'qpoases', qp, opts) Part 5. Upper and Lower Bounds The upper and lower bounds for the constraint vector still needs to be set. The dynamics equation is set up as an equality constraint, so the upper and lower bounds are both zero. The initial condition constraint is also an equality constraint, since the first state vector must be equal to the input state vector. The rest of the constraints have a lower bound close to infinity.\nc_length = np.shape(constr)[0] o_length = np.shape(opt_variables)[0] lbg = list(itertools.repeat(-1e10, c_length)) # inequality constraints: big enough to act like infinity lbg[0:(self.N + 1)] = itertools.repeat(0, self.N + 1) # IC + dynamics equality constraint ubg = list(itertools.repeat(0, c_length)) # inequality constraints Constraints for the optimization variables are set separately. This is where the friction cone restraint for $F_z$ comes into play. The reaction force perpendicular to the ground (assumed flat) must be upward, because the robot can only push itself away from the ground rather than pull itself toward the ground. Therefore, the lower bound on all $F_z$ is 0.\nAdditionally, the MPC must check if each leg is actually in contact with the ground when calculating forces for it. If that leg is not in contact, all bounds are set equal to zero.\n# constraints for optimization variables lbx = list(itertools.repeat(-1e10, o_length)) # input inequality constraints ubx = list(itertools.repeat(1e10, o_length)) # input inequality constraints dyn_len = self.n_states * (self.N + 1) lbx[(dyn_len + 2)::3] = [0 for i in range(20)] # lower bound on all f1z and f2z if c_l == 0: # if left leg is not in contact... don't calculate output forces for that leg. ubx[(self.n_states * (self.N + 1))::6] = [0 for i in range(10)] # upper bound on all f1x ubx[(self.n_states * (self.N + 1) + 1)::6] = [0 for i in range(10)] # upper bound on all f1y lbx[(self.n_states * (self.N + 1))::6] = [0 for i in range(10)] # lower bound on all f1x lbx[(self.n_states * (self.N + 1) + 1)::6] = [0 for i in range(10)] # lower bound on all f1y ubx[(self.n_states * (self.N + 1) + 2)::6] = [0 for i in range(10)] # upper bound on all f1z if c_r == 0: # if right leg is not in contact... don't calculate output forces for that leg. ubx[(self.n_states * (self.N + 1) + 3)::6] = [0 for i in range(10)] # upper bound on all f2x ubx[(self.n_states * (self.N + 1) + 4)::6] = [0 for i in range(10)] # upper bound on all f2y lbx[(self.n_states * (self.N + 1) + 3)::6] = [0 for i in range(10)] # lower bound on all f2x lbx[(self.n_states * (self.N + 1) + 4)::6] = [0 for i in range(10)] # lower bound on all f2y ubx[(self.n_states * (self.N + 1) + 5)::6] = [0 for i in range(10)] # upper bound on all f2z Part 6. Solving Firstly, initial values must be fed into the solver.\nI’ve set the initial values for my control inputs as an array of zeros, although I’m wondering if that should really be the last set of control inputs applied.\nThe initial values for the state are pulled in and calculated from the simulator. This $12\\times1$ array is repeated $N+1$ times, where $N$ is the prediction horizon, in order to fill the entire array including future states.\nu0 = np.zeros((self.N, self.n_controls)) # six control inputs X0 = np.matlib.repmat(x_in, 1, self.N + 1).T # initialization of the state's decision variables parameters = cs.vertcat(x_in, x_ref) # set values of parameters vector # init value of optimization variables x0 = cs.vertcat(np.reshape(X0.T, (self.n_states * (self.N + 1), 1)), np.reshape(u0.T, (self.n_controls * self.N, 1))) Finally, the initial states, bounds, and parameters are plugged into the solver. The controls vector is pulled from the solution, and the first row of optimized control values is returned. The rest of the values (representing future time steps) are ignored.\nsol = solver(x0=x0, lbx=lbx, ubx=ubx, lbg=lbg, ubg=ubg, p=parameters) solu = np.array(sol['x'][self.n_states * (self.N + 1):]) u = np.reshape(solu.T, (self.n_controls, self.N)).T # get controls from the solution u_cl = u[0, :] # ignore rows other than first row return u_cl ","wordCount":"2684","inLanguage":"en","datePublished":"2020-10-12T00:00:00Z","dateModified":"2020-10-12T00:00:00Z","author":{"@type":"Person","name":"Ben Bokser"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://bbokser.github.io/posts/2020-10-12/"},"publisher":{"@type":"Organization","name":"Ben Bokser's Blog","logo":{"@type":"ImageObject","url":"https://bbokser.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://bbokser.github.io/ accesskey=h title="Ben Bokser (Alt + H)">Ben Bokser</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://bbokser.github.io/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://bbokser.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://bbokser.github.io/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://benbokser.com/ title=Portfolio><span>Portfolio</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://bbokser.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://bbokser.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Model Predictive Control for a Legged Robot</h1><div class=post-meta><span title='2020-10-12 00:00:00 +0000 UTC'>October 12, 2020</span>&nbsp;·&nbsp;13 min&nbsp;·&nbsp;Ben Bokser&nbsp;|&nbsp;<a href=https://github.com/bbokser/bbokser.github.io/tree/main/content/posts/2020-10-12.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#part-1-the-dynamics-formulation aria-label="Part 1. The Dynamics Formulation">Part 1. The Dynamics Formulation</a></li><li><a href=#part-2-the-objective-function aria-label="Part 2. The Objective Function">Part 2. The Objective Function</a></li><li><a href=#part-3-the-constraints-vector aria-label="Part 3. The Constraints Vector">Part 3. The Constraints Vector</a></li><li><a href=#part-4-problem-setup aria-label="Part 4. Problem Setup">Part 4. Problem Setup</a></li><li><a href=#part-5-upper-and-lower-bounds aria-label="Part 5. Upper and Lower Bounds">Part 5. Upper and Lower Bounds</a></li><li><a href=#part-6-solving aria-label="Part 6. Solving">Part 6. Solving</a></li></ul></div></details></div><div class=post-content><p>I have recently implemented a model predictive controller (MPC) to calculate the necessary reaction forces for a legged robot. The work presented here is based on <a href=https://arxiv.org/pdf/1909.06586.pdf>this</a> paper by Kim et al. If you don&rsquo;t know what model predictive control is, I recommend <a href=https://youtu.be/YwodGM2eoy4>this</a> excellent explanation by Steve Brunton. I also found <a href=https://youtu.be/RrnkPrcpyEA>this</a> guide to model predictive control with CasADI to be extremely helpful. CasADi is an open source nonlinear optimization tool which I&rsquo;m using for MPC.</p><p>However, I&rsquo;m not entirely sure yet whether this code works the way it&rsquo;s intended&ndash;I&rsquo;m not getting any error messages, but the force values I&rsquo;m getting seem too low. If you spot anything wrong with my implementation, please let me know.</p><p><a href=https://github.com/bbokser/spryped/blob/dev/mpc.py>​Here&rsquo;s</a> the code.</p><h1 id=part-1-the-dynamics-formulation>Part 1. The Dynamics Formulation<a hidden class=anchor aria-hidden=true href=#part-1-the-dynamics-formulation>#</a></h1><p>From the paper, we have the following discrete dynamics:</p><p>$$
x(k+1) = A_kx(k) + B_k \hat{f_k} + \hat{g}
$$</p><p>where,</p><p>$$
\begin{equation}
x = \begin{bmatrix}
\theta^{\top} & p^{\top} & \omega^{\top} & \dot{p}^{\top}
\end{bmatrix}^{\top}
\end{equation}
$$</p><p>$$
\begin{equation}
\hat{f} = \begin{bmatrix}
f_1 & &mldr; & f_n
\end{bmatrix}^{\top}
\end{equation}
$$</p><p>$$
\begin{equation}
\hat{g} = \begin{bmatrix}
0_{1\times{}3} & 0_{1\times{}3} & 0_{1\times{}3} & g^{\top}
\end{bmatrix}^{\top}
\end{equation}
$$</p><p>$$
\begin{equation}
A = \begin{bmatrix}
1_{3\times3} & 0_{3\times3} & R_z(\psi)\Delta t & 0_{3\times3} \newline
0_{3\times3} & 1_{3\times3} & 0_{3\times3} & 1_{3\times3} \Delta t \newline
0_{3\times3} & 0_{3\times3} & 1_{3\times3} & 0_{3\times3} \newline
0_{3\times3} & 0_{3\times3} & 0_{3\times3} & 1_{3\times3}
\end{bmatrix}
\end{equation}
$$</p>$$
\begin{equation}
B = \begin{bmatrix}
0_{3\times3} & 0_{3\times3} \newline
0_{3\times3} & 0_{3\times3} \newline
{}_GI^{-1}[r_1]_\times \Delta t & {}_GI^{-1}[r_1]_\times \Delta t \newline
1_{3\times3} \Delta t /m & 1_{3\times3} \Delta t /m
\end{bmatrix}
\end{equation}
$$<p>First off, you may be wondering what this notation means.</p><p>$[r_1]_\times$ refers to a skew-symmetric matrix. The $3\times1$ vectors $r_1$ and $r_2$ (footstep positions) are converted into a $3\times3$ matrix in order to perform a cross product operation with the inverse of the global inertia tensor.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-matlab data-lang=matlab><span style=display:flex><span><span style=color:#75715e>% matlab code</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>r = [[<span style=color:#ae81ff>0</span>, <span style=color:#f92672>-</span>r_z, r_y];
</span></span><span style=display:flex><span>     [r_z, <span style=color:#ae81ff>0</span>, <span style=color:#f92672>-</span>r_x];
</span></span><span style=display:flex><span>     [<span style=color:#f92672>-</span>r_y, r_x, <span style=color:#ae81ff>0</span>]];
</span></span><span style=display:flex><span>     
</span></span><span style=display:flex><span>i_inv = sym(<span style=color:#e6db74>&#39;i&#39;</span>, [<span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>3</span>]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mtimes(i_inv, r)
</span></span></code></pre></div><p>A few more notes:</p><ul><li>The state term $x$ is a $12\times1$ vector composed of the angle, position, angular velocity, and velocity of the body w.r.t. to the global frame.</li><li>In my case, there are only two legs, so there six scalar control values: $f_{1x}$, $f_{1y}$, $f_{1z}$, $f_{2x}$, $f_{2y}$, $f_{2z}$.</li><li>The gravity term $\hat{g}$ is a $12\times1$ vector of zeros until the last term, which is the gravitational constant.</li><li>$R_z$ is a $3\times3$ rotation matrix for translating angular velocity from the global frame to the body frame.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-matlab data-lang=matlab><span style=display:flex><span><span style=color:#75715e>% matlab code</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>syms theta_x theta_y theta_z p_x p_y p_z omega_x omega_y omega_z pdot_x <span style=color:#75715e>...</span>
</span></span><span style=display:flex><span>     pdot_y pdot_z f1_x f1_y f1_z f2_x f2_y f2_z <span style=color:#75715e>...</span>
</span></span><span style=display:flex><span>     dt i_inv r1x r1y r1z r2x r2y r2z mass gravity<span style=color:#75715e>...</span>
</span></span><span style=display:flex><span>     i11 i12 i13 i21 i22 i23 i31 i32 i33<span style=color:#75715e>...</span>
</span></span><span style=display:flex><span>     rz11 rz12 rz13 rz21 rz22 rz23 rz31 rz32 rz33
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>x = [[theta_x];  <span style=color:#75715e>% states</span>
</span></span><span style=display:flex><span>     [theta_y];
</span></span><span style=display:flex><span>     [theta_z];
</span></span><span style=display:flex><span>     [p_x];
</span></span><span style=display:flex><span>     [p_y];
</span></span><span style=display:flex><span>     [p_z];
</span></span><span style=display:flex><span>     [omega_x];
</span></span><span style=display:flex><span>     [omega_y];
</span></span><span style=display:flex><span>     [omega_z];
</span></span><span style=display:flex><span>     [pdot_x];
</span></span><span style=display:flex><span>     [pdot_y];
</span></span><span style=display:flex><span>     [pdot_z]];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>f = [[f1_x];  <span style=color:#75715e>% controls</span>
</span></span><span style=display:flex><span>     [f1_y];
</span></span><span style=display:flex><span>     [f1_z];
</span></span><span style=display:flex><span>     [f2_x];
</span></span><span style=display:flex><span>     [f2_y];
</span></span><span style=display:flex><span>     [f2_z]];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>g = [[<span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>     [<span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>     [<span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>     [<span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>     [<span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>     [<span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>     [<span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>     [<span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>     [<span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>     [<span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>     [<span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>     [gravity]];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>A = [[<span style=color:#ae81ff>1</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  rz11<span style=color:#f92672>*</span>dt,  rz12<span style=color:#f92672>*</span>dt,  rz13<span style=color:#f92672>*</span>dt,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>     [<span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>1</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  rz21<span style=color:#f92672>*</span>dt,  rz22<span style=color:#f92672>*</span>dt,  rz23<span style=color:#f92672>*</span>dt,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>     [<span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>1</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  rz31<span style=color:#f92672>*</span>dt,  rz32<span style=color:#f92672>*</span>dt,  rz33<span style=color:#f92672>*</span>dt,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>     [<span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>1</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  dt,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>     [<span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>1</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  dt,  <span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>     [<span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>1</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  dt];
</span></span><span style=display:flex><span>     [<span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>1</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>     [<span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>1</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>     [<span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>1</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>     [<span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>1</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>     [<span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>1</span>,  <span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>     [<span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>0</span>,  <span style=color:#ae81ff>1</span>]];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>B = [[<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>     [<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>     [<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>     [<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>     [<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>     [<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>     [(i12<span style=color:#f92672>*</span>r1z <span style=color:#f92672>-</span> i13<span style=color:#f92672>*</span>r1y)<span style=color:#f92672>*</span>dt, (<span style=color:#f92672>-</span>i11<span style=color:#f92672>*</span>r1z <span style=color:#f92672>+</span> i13<span style=color:#f92672>*</span>r1x)<span style=color:#f92672>*</span>dt, (i11<span style=color:#f92672>*</span>r1y <span style=color:#f92672>-</span> i12<span style=color:#f92672>*</span>r1x)<span style=color:#f92672>*</span>dt, <span style=color:#75715e>... </span>
</span></span><span style=display:flex><span>        (i12<span style=color:#f92672>*</span>r2z <span style=color:#f92672>-</span> i13<span style=color:#f92672>*</span>r2y)<span style=color:#f92672>*</span>dt, (<span style=color:#f92672>-</span>i11<span style=color:#f92672>*</span>r2z <span style=color:#f92672>+</span> i13<span style=color:#f92672>*</span>r2x)<span style=color:#f92672>*</span>dt, (i11<span style=color:#f92672>*</span>r2y <span style=color:#f92672>-</span> i12<span style=color:#f92672>*</span>r2x)<span style=color:#f92672>*</span>dt];
</span></span><span style=display:flex><span>     [(i22<span style=color:#f92672>*</span>r1z <span style=color:#f92672>-</span> i23<span style=color:#f92672>*</span>r1y)<span style=color:#f92672>*</span>dt, (<span style=color:#f92672>-</span>i21<span style=color:#f92672>*</span>r1z <span style=color:#f92672>+</span> i23<span style=color:#f92672>*</span>r1x)<span style=color:#f92672>*</span>dt, (i21<span style=color:#f92672>*</span>r1y <span style=color:#f92672>-</span> i22<span style=color:#f92672>*</span>r1x)<span style=color:#f92672>*</span>dt, <span style=color:#75715e>... </span>
</span></span><span style=display:flex><span>        (i22<span style=color:#f92672>*</span>r2z <span style=color:#f92672>-</span> i23<span style=color:#f92672>*</span>r2y)<span style=color:#f92672>*</span>dt, (<span style=color:#f92672>-</span>i21<span style=color:#f92672>*</span>r2z <span style=color:#f92672>+</span> i23<span style=color:#f92672>*</span>r2x)<span style=color:#f92672>*</span>dt, (i21<span style=color:#f92672>*</span>r2y <span style=color:#f92672>-</span> i22<span style=color:#f92672>*</span>r2x)<span style=color:#f92672>*</span>dt];
</span></span><span style=display:flex><span>     [(i32<span style=color:#f92672>*</span>r1z <span style=color:#f92672>-</span> i33<span style=color:#f92672>*</span>r1y)<span style=color:#f92672>*</span>dt, (<span style=color:#f92672>-</span>i31<span style=color:#f92672>*</span>r1z <span style=color:#f92672>+</span> i33<span style=color:#f92672>*</span>r1x)<span style=color:#f92672>*</span>dt, (i31<span style=color:#f92672>*</span>r1y <span style=color:#f92672>-</span> i32<span style=color:#f92672>*</span>r1x)<span style=color:#f92672>*</span>dt, <span style=color:#75715e>... </span>
</span></span><span style=display:flex><span>        (i32<span style=color:#f92672>*</span>r2z <span style=color:#f92672>-</span> i33<span style=color:#f92672>*</span>r2y)<span style=color:#f92672>*</span>dt, (<span style=color:#f92672>-</span>i31<span style=color:#f92672>*</span>r2z <span style=color:#f92672>+</span> i33<span style=color:#f92672>*</span>r2x)<span style=color:#f92672>*</span>dt, (i31<span style=color:#f92672>*</span>r2y <span style=color:#f92672>-</span> i32<span style=color:#f92672>*</span>r2x)<span style=color:#f92672>*</span>dt];
</span></span><span style=display:flex><span>     [dt<span style=color:#f92672>/</span>mass, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, dt<span style=color:#f92672>/</span>mass, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>     [<span style=color:#ae81ff>0</span>, dt<span style=color:#f92672>/</span>mass, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, dt<span style=color:#f92672>/</span>mass, <span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>     [<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, dt<span style=color:#f92672>/</span>mass, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, dt<span style=color:#f92672>/</span>mass]];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>x_next = mtimes(A, x) <span style=color:#f92672>+</span> mtimes(B, f) <span style=color:#f92672>+</span> g;
</span></span></code></pre></div><p>The end result is a very long equation which will be used as a constraint for the QP. The states and controls are defined as symbolics, but other values such as the inertia tensor, rotation matrix, and foot positions are fed in as numerical values from sensor feedback.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># python</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gravity <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>9.807</span>
</span></span><span style=display:flex><span>dt <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>dt
</span></span><span style=display:flex><span>mass <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>mass
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>x_next <span style=color:#f92672>=</span> [dt <span style=color:#f92672>*</span> omega_x <span style=color:#f92672>*</span> rz11 <span style=color:#f92672>+</span> dt <span style=color:#f92672>*</span> omega_y <span style=color:#f92672>*</span> rz12 <span style=color:#f92672>+</span> dt <span style=color:#f92672>*</span> omega_z <span style=color:#f92672>*</span> rz13 <span style=color:#f92672>+</span> theta_x,
</span></span><span style=display:flex><span>          dt <span style=color:#f92672>*</span> omega_x <span style=color:#f92672>*</span> rz21 <span style=color:#f92672>+</span> dt <span style=color:#f92672>*</span> omega_y <span style=color:#f92672>*</span> rz22 <span style=color:#f92672>+</span> dt <span style=color:#f92672>*</span> omega_z <span style=color:#f92672>*</span> rz23 <span style=color:#f92672>+</span> theta_y,
</span></span><span style=display:flex><span>          dt <span style=color:#f92672>*</span> omega_x <span style=color:#f92672>*</span> rz31 <span style=color:#f92672>+</span> dt <span style=color:#f92672>*</span> omega_y <span style=color:#f92672>*</span> rz32 <span style=color:#f92672>+</span> dt <span style=color:#f92672>*</span> omega_z <span style=color:#f92672>*</span> rz33 <span style=color:#f92672>+</span> theta_z,
</span></span><span style=display:flex><span>          dt <span style=color:#f92672>*</span> pdot_x <span style=color:#f92672>+</span> p_x,
</span></span><span style=display:flex><span>          dt <span style=color:#f92672>*</span> pdot_y <span style=color:#f92672>+</span> p_y,
</span></span><span style=display:flex><span>          dt <span style=color:#f92672>*</span> pdot_z <span style=color:#f92672>+</span> p_z,
</span></span><span style=display:flex><span>          dt <span style=color:#f92672>*</span> f1_x <span style=color:#f92672>*</span> (i12 <span style=color:#f92672>*</span> r1z <span style=color:#f92672>-</span> i13 <span style=color:#f92672>*</span> r1y) <span style=color:#f92672>+</span> dt <span style=color:#f92672>*</span> f1_y <span style=color:#f92672>*</span> (<span style=color:#f92672>-</span>i11 <span style=color:#f92672>*</span> r1z <span style=color:#f92672>+</span> i13 <span style=color:#f92672>*</span> r1x)
</span></span><span style=display:flex><span>          <span style=color:#f92672>+</span> dt <span style=color:#f92672>*</span> f1_z <span style=color:#f92672>*</span> (i11 <span style=color:#f92672>*</span> r1y <span style=color:#f92672>-</span> i12 <span style=color:#f92672>*</span> r1x) <span style=color:#f92672>+</span> dt <span style=color:#f92672>*</span> f2_x <span style=color:#f92672>*</span> (i12 <span style=color:#f92672>*</span> r2z <span style=color:#f92672>-</span> i13 <span style=color:#f92672>*</span> r2y)
</span></span><span style=display:flex><span>          <span style=color:#f92672>+</span> dt <span style=color:#f92672>*</span> f2_y <span style=color:#f92672>*</span> (<span style=color:#f92672>-</span>i11 <span style=color:#f92672>*</span> r2z <span style=color:#f92672>+</span> i13 <span style=color:#f92672>*</span> r2x) <span style=color:#f92672>+</span> dt <span style=color:#f92672>*</span> f2_z <span style=color:#f92672>*</span> (i11 <span style=color:#f92672>*</span> r2y <span style=color:#f92672>-</span> i12 <span style=color:#f92672>*</span> r2x) <span style=color:#f92672>+</span> omega_x,
</span></span><span style=display:flex><span>          dt <span style=color:#f92672>*</span> f1_x <span style=color:#f92672>*</span> (i22 <span style=color:#f92672>*</span> r1z <span style=color:#f92672>-</span> i23 <span style=color:#f92672>*</span> r1y) <span style=color:#f92672>+</span> dt <span style=color:#f92672>*</span> f1_y <span style=color:#f92672>*</span> (<span style=color:#f92672>-</span>i21 <span style=color:#f92672>*</span> r1z <span style=color:#f92672>+</span> i23 <span style=color:#f92672>*</span> r1x)
</span></span><span style=display:flex><span>          <span style=color:#f92672>+</span> dt <span style=color:#f92672>*</span> f1_z <span style=color:#f92672>*</span> (i21 <span style=color:#f92672>*</span> r1y <span style=color:#f92672>-</span> i22 <span style=color:#f92672>*</span> r1x) <span style=color:#f92672>+</span> dt <span style=color:#f92672>*</span> f2_x <span style=color:#f92672>*</span> (i22 <span style=color:#f92672>*</span> r2z <span style=color:#f92672>-</span> i23 <span style=color:#f92672>*</span> r2y)
</span></span><span style=display:flex><span>          <span style=color:#f92672>+</span> dt <span style=color:#f92672>*</span> f2_y <span style=color:#f92672>*</span> (<span style=color:#f92672>-</span>i21 <span style=color:#f92672>*</span> r2z <span style=color:#f92672>+</span> i23 <span style=color:#f92672>*</span> r2x) <span style=color:#f92672>+</span> dt <span style=color:#f92672>*</span> f2_z <span style=color:#f92672>*</span> (i21 <span style=color:#f92672>*</span> r2y <span style=color:#f92672>-</span> i22 <span style=color:#f92672>*</span> r2x) <span style=color:#f92672>+</span> omega_y,
</span></span><span style=display:flex><span>          dt <span style=color:#f92672>*</span> f1_x <span style=color:#f92672>*</span> (i32 <span style=color:#f92672>*</span> r1z <span style=color:#f92672>-</span> i33 <span style=color:#f92672>*</span> r1y) <span style=color:#f92672>+</span> dt <span style=color:#f92672>*</span> f1_y <span style=color:#f92672>*</span> (<span style=color:#f92672>-</span>i31 <span style=color:#f92672>*</span> r1z <span style=color:#f92672>+</span> i33 <span style=color:#f92672>*</span> r1x)
</span></span><span style=display:flex><span>          <span style=color:#f92672>+</span> dt <span style=color:#f92672>*</span> f1_z <span style=color:#f92672>*</span> (i31 <span style=color:#f92672>*</span> r1y <span style=color:#f92672>-</span> i32 <span style=color:#f92672>*</span> r1x) <span style=color:#f92672>+</span> dt <span style=color:#f92672>*</span> f2_x <span style=color:#f92672>*</span> (i32 <span style=color:#f92672>*</span> r2z <span style=color:#f92672>-</span> i33 <span style=color:#f92672>*</span> r2y)
</span></span><span style=display:flex><span>          <span style=color:#f92672>+</span> dt <span style=color:#f92672>*</span> f2_y <span style=color:#f92672>*</span> (<span style=color:#f92672>-</span>i31 <span style=color:#f92672>*</span> r2z <span style=color:#f92672>+</span> i33 <span style=color:#f92672>*</span> r2x) <span style=color:#f92672>+</span> dt <span style=color:#f92672>*</span> f2_z <span style=color:#f92672>*</span> (i31 <span style=color:#f92672>*</span> r2y <span style=color:#f92672>-</span> i32 <span style=color:#f92672>*</span> r2x) <span style=color:#f92672>+</span> omega_z,
</span></span><span style=display:flex><span>          dt <span style=color:#f92672>*</span> f1_x <span style=color:#f92672>/</span> mass <span style=color:#f92672>+</span> dt <span style=color:#f92672>*</span> f2_x <span style=color:#f92672>/</span> mass <span style=color:#f92672>+</span> pdot_x,
</span></span><span style=display:flex><span>          dt <span style=color:#f92672>*</span> f1_y <span style=color:#f92672>/</span> mass <span style=color:#f92672>+</span> dt <span style=color:#f92672>*</span> f2_y <span style=color:#f92672>/</span> mass <span style=color:#f92672>+</span> pdot_y,
</span></span><span style=display:flex><span>          dt <span style=color:#f92672>*</span> f1_z <span style=color:#f92672>/</span> mass <span style=color:#f92672>+</span> dt <span style=color:#f92672>*</span> f2_z <span style=color:#f92672>/</span> mass <span style=color:#f92672>+</span> gravity <span style=color:#f92672>+</span> pdot_z]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>self<span style=color:#f92672>.</span>fn <span style=color:#f92672>=</span> cs<span style=color:#f92672>.</span>Function(<span style=color:#e6db74>&#39;fn&#39;</span>, [theta_x, theta_y, theta_z,
</span></span><span style=display:flex><span>                      p_x, p_y, p_z,
</span></span><span style=display:flex><span>                      omega_x, omega_y, omega_z,
</span></span><span style=display:flex><span>                      pdot_x, pdot_y, pdot_z,
</span></span><span style=display:flex><span>                      f1_x, f1_y, f1_z,
</span></span><span style=display:flex><span>                      f2_x, f2_y, f2_z],
</span></span><span style=display:flex><span>                      x_next)  <span style=color:#75715e># nonlinear mapping of function f(x,u)</span>
</span></span></code></pre></div><h1 id=part-2-the-objective-function>Part 2. The Objective Function<a hidden class=anchor aria-hidden=true href=#part-2-the-objective-function>#</a></h1><p>$$
\begin{align}
\min_{x,f} \quad & \sum^{m}_{k=0} \lVert x(k+1) - x^{ref}(k+1) \lVert_Q + \lVert f_k\lVert_R
\end{align}
$$</p><p>The objective function is shown above.</p><p>$$
\lVert f(k)\lVert_R
$$</p><p>Let&rsquo;s start with this notation. What does it mean? Well, double bars represent a matrix norm. However, the R in subscript clues us into the fact that this is a special case of the matrix norm with an inner product. Q and R are weighing matrices and should be diagonal.</p>$$
\begin{equation}
\lVert f(k)\lVert_R = \sqrt{f(k)_R} = \sqrt{f(k)*R*f(k)}
\end{equation}
$$<p>However, I&rsquo;m not sure what the purpose of the square root would be here. It seems to me that minimizing the square root of $f(x)$ is basically equivalent to minimizing $f(x)$ by itself, but more computationally expensive. In fact, running the code with the square root operation actually causes a <code>QP is infeasible!</code> error. As such, I&rsquo;m leaving the square root operation out.</p><p>So, the objective function minimizes $x$ and $f$ (the state and control vectors) based on the difference between actual and reference state as well as the value of $f$, scaled to Q and R respectively, over $k$ time steps where $k$ is between 0 and $m$. Here, $m$ refers to the prediction horizon, which is chosen by the user.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>u <span style=color:#f92672>=</span> cs<span style=color:#f92672>.</span>SX<span style=color:#f92672>.</span>sym(<span style=color:#e6db74>&#39;u&#39;</span>, self<span style=color:#f92672>.</span>n_controls, self<span style=color:#f92672>.</span>N)  <span style=color:#75715e># decision variables, control action matrix</span>
</span></span><span style=display:flex><span>st_ref <span style=color:#f92672>=</span> cs<span style=color:#f92672>.</span>SX<span style=color:#f92672>.</span>sym(<span style=color:#e6db74>&#39;st_ref&#39;</span>, self<span style=color:#f92672>.</span>n_states <span style=color:#f92672>+</span> self<span style=color:#f92672>.</span>n_states)  <span style=color:#75715e># initial and reference states</span>
</span></span><span style=display:flex><span>x <span style=color:#f92672>=</span> cs<span style=color:#f92672>.</span>SX<span style=color:#f92672>.</span>sym(<span style=color:#e6db74>&#39;x&#39;</span>, self<span style=color:#f92672>.</span>n_states, (self<span style=color:#f92672>.</span>N <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>))  <span style=color:#75715e># represents the states over the opt problem.</span>
</span></span><span style=display:flex><span>obj <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>  <span style=color:#75715e># cs.SX(0)  # objective function</span>
</span></span><span style=display:flex><span>constr <span style=color:#f92672>=</span> []  <span style=color:#75715e># constraints vector</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Q <span style=color:#f92672>=</span> np<span style=color:#f92672>.</span>zeros((<span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>12</span>))  <span style=color:#75715e># state weighing matrix</span>
</span></span><span style=display:flex><span>Q[<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>Q[<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>Q[<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>2</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>Q[<span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>3</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>Q[<span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>4</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>Q[<span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>5</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>Q[<span style=color:#ae81ff>6</span>, <span style=color:#ae81ff>6</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>Q[<span style=color:#ae81ff>7</span>, <span style=color:#ae81ff>7</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>Q[<span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>8</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>Q[<span style=color:#ae81ff>9</span>, <span style=color:#ae81ff>9</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>Q[<span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>10</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>Q[<span style=color:#ae81ff>11</span>, <span style=color:#ae81ff>11</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>R <span style=color:#f92672>=</span> np<span style=color:#f92672>.</span>zeros((<span style=color:#ae81ff>6</span>, <span style=color:#ae81ff>6</span>))  <span style=color:#75715e># control weighing matrix</span>
</span></span><span style=display:flex><span>R[<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>R[<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>R[<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>2</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>R[<span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>3</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>R[<span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>4</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>R[<span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>5</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>st <span style=color:#f92672>=</span> x[:, <span style=color:#ae81ff>0</span>]  <span style=color:#75715e># initial state</span>
</span></span><span style=display:flex><span>constr <span style=color:#f92672>=</span> cs<span style=color:#f92672>.</span>vertcat(constr, st <span style=color:#f92672>-</span> st_ref[<span style=color:#ae81ff>0</span>:self<span style=color:#f92672>.</span>n_states])  <span style=color:#75715e># initial condition constraints</span>
</span></span><span style=display:flex><span><span style=color:#75715e># compute objective and constraints</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> k <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>0</span>, self<span style=color:#f92672>.</span>N):
</span></span><span style=display:flex><span>    st <span style=color:#f92672>=</span> x[:, k]  <span style=color:#75715e># state</span>
</span></span><span style=display:flex><span>    con <span style=color:#f92672>=</span> u[:, k]  <span style=color:#75715e># control action</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># calculate objective</span>
</span></span><span style=display:flex><span>    obj <span style=color:#f92672>=</span> obj <span style=color:#f92672>+</span> cs<span style=color:#f92672>.</span>mtimes(cs<span style=color:#f92672>.</span>mtimes((st <span style=color:#f92672>-</span> st_ref[self<span style=color:#f92672>.</span>n_states:(self<span style=color:#f92672>.</span>n_states <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span>)])<span style=color:#f92672>.</span>T, Q),
</span></span><span style=display:flex><span>                          st <span style=color:#f92672>-</span> st_ref[self<span style=color:#f92672>.</span>n_states:(self<span style=color:#f92672>.</span>n_states <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span>)])) \
</span></span><span style=display:flex><span>        <span style=color:#f92672>+</span> cs<span style=color:#f92672>.</span>mtimes(cs<span style=color:#f92672>.</span>mtimes(con<span style=color:#f92672>.</span>T, R), con))
</span></span></code></pre></div><p>Both my Q and R are identity matrices right now, as I have not yet tuned them.</p><h1 id=part-3-the-constraints-vector>Part 3. The Constraints Vector<a hidden class=anchor aria-hidden=true href=#part-3-the-constraints-vector>#</a></h1><p>In the same for loop, we can now add the constraints vector. For each iteration of the loop, the discrete dynamics equation from Part 1 is subtracted from the next state vector, $x(k+1)$.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>for</span> k <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>0</span>, self<span style=color:#f92672>.</span>N):
</span></span><span style=display:flex><span>    <span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span>    st_next <span style=color:#f92672>=</span> x[:, k <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>    f_value <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>fn(st[<span style=color:#ae81ff>0</span>], st[<span style=color:#ae81ff>1</span>], st[<span style=color:#ae81ff>2</span>], st[<span style=color:#ae81ff>3</span>], st[<span style=color:#ae81ff>4</span>], st[<span style=color:#ae81ff>5</span>],
</span></span><span style=display:flex><span>                      st[<span style=color:#ae81ff>6</span>], st[<span style=color:#ae81ff>7</span>], st[<span style=color:#ae81ff>8</span>], st[<span style=color:#ae81ff>9</span>], st[<span style=color:#ae81ff>10</span>], st[<span style=color:#ae81ff>11</span>],
</span></span><span style=display:flex><span>                      con[<span style=color:#ae81ff>0</span>], con[<span style=color:#ae81ff>1</span>], con[<span style=color:#ae81ff>2</span>], con[<span style=color:#ae81ff>3</span>], con[<span style=color:#ae81ff>4</span>], con[<span style=color:#ae81ff>5</span>])
</span></span><span style=display:flex><span>    st_n_e <span style=color:#f92672>=</span> np<span style=color:#f92672>.</span>array(f_value)
</span></span><span style=display:flex><span>    constr <span style=color:#f92672>=</span> cs<span style=color:#f92672>.</span>vertcat(constr, st_next <span style=color:#f92672>-</span> st_n_e)  <span style=color:#75715e># compute constraints</span>
</span></span></code></pre></div><p>There are more constraints, however. Namely, friction cone constraints, governed by friction of the feet with the ground. As stated in the paper:</p><p>$$
\begin{equation}
\vert{}f_x\vert{} \leq \mu f_z
\end{equation}
$$</p><p>$$
\begin{equation}
\vert{}f_x\vert{} \leq \mu f_z
\end{equation}
$$</p><p>$$
\begin{equation}
f_z > 0
\end{equation}
$$</p><p>Here&rsquo;s my implementation below. Both the $F_x$ and $F_y$ inequalities must be repeated due to the absolute value function. $F_z$ is not required here because it&rsquo;s extremely simple and can be implemented as an input constraint.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># add additional constraints</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> k <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>0</span>, self<span style=color:#f92672>.</span>N):
</span></span><span style=display:flex><span>    constr <span style=color:#f92672>=</span> cs<span style=color:#f92672>.</span>vertcat(constr, u[<span style=color:#ae81ff>0</span>, k] <span style=color:#f92672>-</span> self<span style=color:#f92672>.</span>mu <span style=color:#f92672>*</span> u[<span style=color:#ae81ff>2</span>, k])  <span style=color:#75715e># f1x - mu*f1z</span>
</span></span><span style=display:flex><span>    constr <span style=color:#f92672>=</span> cs<span style=color:#f92672>.</span>vertcat(constr, <span style=color:#f92672>-</span>u[<span style=color:#ae81ff>0</span>, k] <span style=color:#f92672>-</span> self<span style=color:#f92672>.</span>mu <span style=color:#f92672>*</span> u[<span style=color:#ae81ff>2</span>, k])  <span style=color:#75715e># -f1x - mu*f1z</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    constr <span style=color:#f92672>=</span> cs<span style=color:#f92672>.</span>vertcat(constr, u[<span style=color:#ae81ff>1</span>, k] <span style=color:#f92672>-</span> self<span style=color:#f92672>.</span>mu <span style=color:#f92672>*</span> u[<span style=color:#ae81ff>2</span>, k])  <span style=color:#75715e># f1y - mu*f1z</span>
</span></span><span style=display:flex><span>    constr <span style=color:#f92672>=</span> cs<span style=color:#f92672>.</span>vertcat(constr, <span style=color:#f92672>-</span>u[<span style=color:#ae81ff>1</span>, k] <span style=color:#f92672>-</span> self<span style=color:#f92672>.</span>mu <span style=color:#f92672>*</span> u[<span style=color:#ae81ff>2</span>, k])  <span style=color:#75715e># -f1y - mu*f1z</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    constr <span style=color:#f92672>=</span> cs<span style=color:#f92672>.</span>vertcat(constr, u[<span style=color:#ae81ff>3</span>, k] <span style=color:#f92672>-</span> self<span style=color:#f92672>.</span>mu <span style=color:#f92672>*</span> u[<span style=color:#ae81ff>5</span>, k])  <span style=color:#75715e># f2x - mu*f2z</span>
</span></span><span style=display:flex><span>    constr <span style=color:#f92672>=</span> cs<span style=color:#f92672>.</span>vertcat(constr, <span style=color:#f92672>-</span>u[<span style=color:#ae81ff>3</span>, k] <span style=color:#f92672>-</span> self<span style=color:#f92672>.</span>mu <span style=color:#f92672>*</span> u[<span style=color:#ae81ff>5</span>, k])  <span style=color:#75715e># -f2x - mu*f2z</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    constr <span style=color:#f92672>=</span> cs<span style=color:#f92672>.</span>vertcat(constr, u[<span style=color:#ae81ff>4</span>, k] <span style=color:#f92672>-</span> self<span style=color:#f92672>.</span>mu <span style=color:#f92672>*</span> u[<span style=color:#ae81ff>5</span>, k])  <span style=color:#75715e># f2y - mu*f2z</span>
</span></span><span style=display:flex><span>    constr <span style=color:#f92672>=</span> cs<span style=color:#f92672>.</span>vertcat(constr, <span style=color:#f92672>-</span>u[<span style=color:#ae81ff>4</span>, k] <span style=color:#f92672>-</span> self<span style=color:#f92672>.</span>mu <span style=color:#f92672>*</span> u[<span style=color:#ae81ff>5</span>, k])  <span style=color:#75715e># -f2y - mu*f2z</span>
</span></span></code></pre></div><h1 id=part-4-problem-setup>Part 4. Problem Setup<a hidden class=anchor aria-hidden=true href=#part-4-problem-setup>#</a></h1><p>The solver used here is qpOASES. The optimization variables (in this case, the state and controls), objective function, constraint functions, and reference state are declared as shown. It is important to specify a bound tolerance and termination tolerance.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>opt_variables <span style=color:#f92672>=</span> cs<span style=color:#f92672>.</span>vertcat(cs<span style=color:#f92672>.</span>reshape(x, n_states <span style=color:#f92672>*</span> (self<span style=color:#f92672>.</span>N <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>), <span style=color:#ae81ff>1</span>),
</span></span><span style=display:flex><span>                                   cs<span style=color:#f92672>.</span>reshape(u, n_controls <span style=color:#f92672>*</span> self<span style=color:#f92672>.</span>N, <span style=color:#ae81ff>1</span>))
</span></span><span style=display:flex><span>qp <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#39;x&#39;</span>: opt_variables, <span style=color:#e6db74>&#39;f&#39;</span>: obj, <span style=color:#e6db74>&#39;g&#39;</span>: constr, <span style=color:#e6db74>&#39;p&#39;</span>: st_ref}
</span></span><span style=display:flex><span>opts <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#39;print_time&#39;</span>: <span style=color:#ae81ff>0</span>, <span style=color:#e6db74>&#39;error_on_fail&#39;</span>: <span style=color:#ae81ff>0</span>, <span style=color:#e6db74>&#39;printLevel&#39;</span>: <span style=color:#e6db74>&#34;low&#34;</span>, <span style=color:#e6db74>&#39;boundTolerance&#39;</span>: <span style=color:#ae81ff>1e-6</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;terminationTolerance&#39;</span>: <span style=color:#ae81ff>1e-6</span>}
</span></span><span style=display:flex><span>solver <span style=color:#f92672>=</span> cs<span style=color:#f92672>.</span>qpsol(<span style=color:#e6db74>&#39;S&#39;</span>, <span style=color:#e6db74>&#39;qpoases&#39;</span>, qp, opts)
</span></span></code></pre></div><h1 id=part-5-upper-and-lower-bounds>Part 5. Upper and Lower Bounds<a hidden class=anchor aria-hidden=true href=#part-5-upper-and-lower-bounds>#</a></h1><p>The upper and lower bounds for the constraint vector still needs to be set. The dynamics equation is set up as an equality constraint, so the upper and lower bounds are both zero. The initial condition constraint is also an equality constraint, since the first state vector must be equal to the input state vector. The rest of the constraints have a lower bound close to infinity.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>c_length <span style=color:#f92672>=</span> np<span style=color:#f92672>.</span>shape(constr)[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>o_length <span style=color:#f92672>=</span> np<span style=color:#f92672>.</span>shape(opt_variables)[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>lbg <span style=color:#f92672>=</span> list(itertools<span style=color:#f92672>.</span>repeat(<span style=color:#f92672>-</span><span style=color:#ae81ff>1e10</span>, c_length))  <span style=color:#75715e># inequality constraints: big enough to act like infinity</span>
</span></span><span style=display:flex><span>lbg[<span style=color:#ae81ff>0</span>:(self<span style=color:#f92672>.</span>N <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>)] <span style=color:#f92672>=</span> itertools<span style=color:#f92672>.</span>repeat(<span style=color:#ae81ff>0</span>, self<span style=color:#f92672>.</span>N <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>)  <span style=color:#75715e># IC + dynamics equality constraint</span>
</span></span><span style=display:flex><span>ubg <span style=color:#f92672>=</span> list(itertools<span style=color:#f92672>.</span>repeat(<span style=color:#ae81ff>0</span>, c_length))  <span style=color:#75715e># inequality constraints</span>
</span></span></code></pre></div><p>Constraints for the optimization variables are set separately. This is where the friction cone restraint for $F_z$ comes into play. The reaction force perpendicular to the ground (assumed flat) must be upward, because the robot can only push itself away from the ground rather than pull itself toward the ground. Therefore, the lower bound on all $F_z$ is 0.</p><p>Additionally, the MPC must check if each leg is actually in contact with the ground when calculating forces for it. If that leg is not in contact, all bounds are set equal to zero.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># constraints for optimization variables</span>
</span></span><span style=display:flex><span>lbx <span style=color:#f92672>=</span> list(itertools<span style=color:#f92672>.</span>repeat(<span style=color:#f92672>-</span><span style=color:#ae81ff>1e10</span>, o_length))  <span style=color:#75715e># input inequality constraints</span>
</span></span><span style=display:flex><span>ubx <span style=color:#f92672>=</span> list(itertools<span style=color:#f92672>.</span>repeat(<span style=color:#ae81ff>1e10</span>, o_length))  <span style=color:#75715e># input inequality constraints</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>dyn_len <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>n_states <span style=color:#f92672>*</span> (self<span style=color:#f92672>.</span>N <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>lbx[(dyn_len <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span>)::<span style=color:#ae81ff>3</span>] <span style=color:#f92672>=</span> [<span style=color:#ae81ff>0</span> <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>20</span>)]  <span style=color:#75715e># lower bound on all f1z and f2z</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> c_l <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:  <span style=color:#75715e># if left leg is not in contact... don&#39;t calculate output forces for that leg.</span>
</span></span><span style=display:flex><span>    ubx[(self<span style=color:#f92672>.</span>n_states <span style=color:#f92672>*</span> (self<span style=color:#f92672>.</span>N <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>))::<span style=color:#ae81ff>6</span>] <span style=color:#f92672>=</span> [<span style=color:#ae81ff>0</span> <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>10</span>)]  <span style=color:#75715e># upper bound on all f1x</span>
</span></span><span style=display:flex><span>    ubx[(self<span style=color:#f92672>.</span>n_states <span style=color:#f92672>*</span> (self<span style=color:#f92672>.</span>N <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>)::<span style=color:#ae81ff>6</span>] <span style=color:#f92672>=</span> [<span style=color:#ae81ff>0</span> <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>10</span>)]  <span style=color:#75715e># upper bound on all f1y</span>
</span></span><span style=display:flex><span>    lbx[(self<span style=color:#f92672>.</span>n_states <span style=color:#f92672>*</span> (self<span style=color:#f92672>.</span>N <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>))::<span style=color:#ae81ff>6</span>] <span style=color:#f92672>=</span> [<span style=color:#ae81ff>0</span> <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>10</span>)]  <span style=color:#75715e># lower bound on all f1x</span>
</span></span><span style=display:flex><span>    lbx[(self<span style=color:#f92672>.</span>n_states <span style=color:#f92672>*</span> (self<span style=color:#f92672>.</span>N <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>)::<span style=color:#ae81ff>6</span>] <span style=color:#f92672>=</span> [<span style=color:#ae81ff>0</span> <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>10</span>)]  <span style=color:#75715e># lower bound on all f1y</span>
</span></span><span style=display:flex><span>    ubx[(self<span style=color:#f92672>.</span>n_states <span style=color:#f92672>*</span> (self<span style=color:#f92672>.</span>N <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span>)::<span style=color:#ae81ff>6</span>] <span style=color:#f92672>=</span> [<span style=color:#ae81ff>0</span> <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>10</span>)]  <span style=color:#75715e># upper bound on all f1z</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> c_r <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:  <span style=color:#75715e># if right leg is not in contact... don&#39;t calculate output forces for that leg.</span>
</span></span><span style=display:flex><span>    ubx[(self<span style=color:#f92672>.</span>n_states <span style=color:#f92672>*</span> (self<span style=color:#f92672>.</span>N <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>3</span>)::<span style=color:#ae81ff>6</span>] <span style=color:#f92672>=</span> [<span style=color:#ae81ff>0</span> <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>10</span>)]  <span style=color:#75715e># upper bound on all f2x</span>
</span></span><span style=display:flex><span>    ubx[(self<span style=color:#f92672>.</span>n_states <span style=color:#f92672>*</span> (self<span style=color:#f92672>.</span>N <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span>)::<span style=color:#ae81ff>6</span>] <span style=color:#f92672>=</span> [<span style=color:#ae81ff>0</span> <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>10</span>)]  <span style=color:#75715e># upper bound on all f2y</span>
</span></span><span style=display:flex><span>    lbx[(self<span style=color:#f92672>.</span>n_states <span style=color:#f92672>*</span> (self<span style=color:#f92672>.</span>N <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>3</span>)::<span style=color:#ae81ff>6</span>] <span style=color:#f92672>=</span> [<span style=color:#ae81ff>0</span> <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>10</span>)]  <span style=color:#75715e># lower bound on all f2x</span>
</span></span><span style=display:flex><span>    lbx[(self<span style=color:#f92672>.</span>n_states <span style=color:#f92672>*</span> (self<span style=color:#f92672>.</span>N <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span>)::<span style=color:#ae81ff>6</span>] <span style=color:#f92672>=</span> [<span style=color:#ae81ff>0</span> <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>10</span>)]  <span style=color:#75715e># lower bound on all f2y</span>
</span></span><span style=display:flex><span>    ubx[(self<span style=color:#f92672>.</span>n_states <span style=color:#f92672>*</span> (self<span style=color:#f92672>.</span>N <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>5</span>)::<span style=color:#ae81ff>6</span>] <span style=color:#f92672>=</span> [<span style=color:#ae81ff>0</span> <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>10</span>)]  <span style=color:#75715e># upper bound on all f2z</span>
</span></span></code></pre></div><h1 id=part-6-solving>Part 6. Solving<a hidden class=anchor aria-hidden=true href=#part-6-solving>#</a></h1><p>Firstly, initial values must be fed into the solver.</p><p>I&rsquo;ve set the initial values for my control inputs as an array of zeros, although I&rsquo;m wondering if that should really be the last set of control inputs applied.</p><p>The initial values for the state are pulled in and calculated from the simulator. This $12\times1$ array is repeated $N+1$ times, where $N$ is the prediction horizon, in order to fill the entire array including future states.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>u0 <span style=color:#f92672>=</span> np<span style=color:#f92672>.</span>zeros((self<span style=color:#f92672>.</span>N, self<span style=color:#f92672>.</span>n_controls))  <span style=color:#75715e># six control inputs</span>
</span></span><span style=display:flex><span>X0 <span style=color:#f92672>=</span> np<span style=color:#f92672>.</span>matlib<span style=color:#f92672>.</span>repmat(x_in, <span style=color:#ae81ff>1</span>, self<span style=color:#f92672>.</span>N <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>)<span style=color:#f92672>.</span>T  <span style=color:#75715e># initialization of the state&#39;s decision variables</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>parameters <span style=color:#f92672>=</span> cs<span style=color:#f92672>.</span>vertcat(x_in, x_ref)  <span style=color:#75715e># set values of parameters vector</span>
</span></span><span style=display:flex><span><span style=color:#75715e># init value of optimization variables</span>
</span></span><span style=display:flex><span>x0 <span style=color:#f92672>=</span> cs<span style=color:#f92672>.</span>vertcat(np<span style=color:#f92672>.</span>reshape(X0<span style=color:#f92672>.</span>T, (self<span style=color:#f92672>.</span>n_states <span style=color:#f92672>*</span> (self<span style=color:#f92672>.</span>N <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>), <span style=color:#ae81ff>1</span>)),
</span></span><span style=display:flex><span>                np<span style=color:#f92672>.</span>reshape(u0<span style=color:#f92672>.</span>T, (self<span style=color:#f92672>.</span>n_controls <span style=color:#f92672>*</span> self<span style=color:#f92672>.</span>N, <span style=color:#ae81ff>1</span>)))
</span></span></code></pre></div><p>Finally, the initial states, bounds, and parameters are plugged into the solver. The controls vector is pulled from the solution, and the first row of optimized control values is returned. The rest of the values (representing future time steps) are ignored.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>sol <span style=color:#f92672>=</span> solver(x0<span style=color:#f92672>=</span>x0, lbx<span style=color:#f92672>=</span>lbx, ubx<span style=color:#f92672>=</span>ubx, lbg<span style=color:#f92672>=</span>lbg, ubg<span style=color:#f92672>=</span>ubg, p<span style=color:#f92672>=</span>parameters)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>solu <span style=color:#f92672>=</span> np<span style=color:#f92672>.</span>array(sol[<span style=color:#e6db74>&#39;x&#39;</span>][self<span style=color:#f92672>.</span>n_states <span style=color:#f92672>*</span> (self<span style=color:#f92672>.</span>N <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>):])
</span></span><span style=display:flex><span>u <span style=color:#f92672>=</span> np<span style=color:#f92672>.</span>reshape(solu<span style=color:#f92672>.</span>T, (self<span style=color:#f92672>.</span>n_controls, self<span style=color:#f92672>.</span>N))<span style=color:#f92672>.</span>T  <span style=color:#75715e># get controls from the solution</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>u_cl <span style=color:#f92672>=</span> u[<span style=color:#ae81ff>0</span>, :]  <span style=color:#75715e># ignore rows other than first row</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>return</span> u_cl
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://bbokser.github.io/tags/control/>Control</a></li><li><a href=https://bbokser.github.io/tags/spryped/>Spryped</a></li></ul><nav class=paginav><a class=prev href=https://bbokser.github.io/posts/2021-07-20/><span class=title>« Prev</span><br><span>Stable Bipedal Walking in Simulation</span>
</a><a class=next href=https://bbokser.github.io/posts/2020-05-04/><span class=title>Next »</span><br><span>Solving for the Jacobians of a Robot Leg</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Model Predictive Control for a Legged Robot on x" href="https://x.com/intent/tweet/?text=Model%20Predictive%20Control%20for%20a%20Legged%20Robot&amp;url=https%3a%2f%2fbbokser.github.io%2fposts%2f2020-10-12%2f&amp;hashtags=control%2cspryped"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Model Predictive Control for a Legged Robot on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fbbokser.github.io%2fposts%2f2020-10-12%2f&amp;title=Model%20Predictive%20Control%20for%20a%20Legged%20Robot&amp;summary=Model%20Predictive%20Control%20for%20a%20Legged%20Robot&amp;source=https%3a%2f%2fbbokser.github.io%2fposts%2f2020-10-12%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Model Predictive Control for a Legged Robot on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fbbokser.github.io%2fposts%2f2020-10-12%2f&title=Model%20Predictive%20Control%20for%20a%20Legged%20Robot"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Model Predictive Control for a Legged Robot on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fbbokser.github.io%2fposts%2f2020-10-12%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Model Predictive Control for a Legged Robot on whatsapp" href="https://api.whatsapp.com/send?text=Model%20Predictive%20Control%20for%20a%20Legged%20Robot%20-%20https%3a%2f%2fbbokser.github.io%2fposts%2f2020-10-12%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Model Predictive Control for a Legged Robot on telegram" href="https://telegram.me/share/url?text=Model%20Predictive%20Control%20for%20a%20Legged%20Robot&amp;url=https%3a%2f%2fbbokser.github.io%2fposts%2f2020-10-12%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Model Predictive Control for a Legged Robot on ycombinator" href="https://news.ycombinator.com/submitlink?t=Model%20Predictive%20Control%20for%20a%20Legged%20Robot&u=https%3a%2f%2fbbokser.github.io%2fposts%2f2020-10-12%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer><div class=giscus><script>function getGiscusTheme(){const e=localStorage.getItem("pref-theme"),t=e==null||e=="light"?"light":"dark";return t}function setGiscusTheme(){function e(e){const t=document.querySelector("iframe.giscus-frame");if(!t)return;t.contentWindow.postMessage({giscus:e},"https://giscus.app")}e({setConfig:{theme:getGiscusTheme()=="light"?"dark":"light"}})}const attrs={src:"https://giscus.app/client.js","data-repo":"bbokser/bbokser.github.io","data-repo-id":"R_kgDOGxN6Pg","data-category":"Announcements","data-category-id":"DIC_kwDOIWVKbs4CSTz_","data-mapping":"title","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"bottom","data-theme":getGiscusTheme(),"data-lang":"en",crossorigin:"anonymous",async:""},giscusScript=document.createElement("script");Object.entries(attrs).forEach(([e,t])=>giscusScript.setAttribute(e,t)),document.body.appendChild(giscusScript);const toggle=document.querySelector("#theme-toggle");toggle&&toggle.addEventListener("click",setGiscusTheme)</script><noscript>Please enable JavaScript to view the comments</noscript></article></main><footer class=footer><span>&copy; 2025 <a href=https://bbokser.github.io/>Ben Bokser's Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>